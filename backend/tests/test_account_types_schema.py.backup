"""
Tests for account types database schema changes.
Tests the new columns: account_type, profile_id, entity_id, last_managed_at
"""

import pytest
from datetime import datetime, timezone
from sqlalchemy import create_engine, Column, String, DateTime, BigInteger, CheckConstraint
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from sqlalchemy.exc import IntegrityError
from unittest.mock import Mock, patch
import sys
import os

# Add the app directory to the path
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from app.models.amazon_account import AmazonAccount
from app.db.session import Base


class TestAccountTypesSchema:
    """Test suite for account types schema changes."""

    @pytest.fixture
    def test_db(self):
        """Create a test database session."""
        engine = create_engine("sqlite:///:memory:")
        Base.metadata.create_all(engine)
        SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
        session = SessionLocal()
        yield session
        session.close()

    def test_account_type_column_accepts_valid_values(self, test_db):
        """Test that account_type column accepts valid values (advertising, dsp, amc)."""
        # Test advertising type
        account_advertising = AmazonAccount(
            user_id="test-user-1",
            account_name="Test Sponsored Ads Account",
            amazon_account_id="ENTITY123",
            account_type="advertising",
            marketplace_id="ATVPDKIKX0DER"
        )
        test_db.add(account_advertising)

        # Test DSP type
        account_dsp = AmazonAccount(
            user_id="test-user-1",
            account_name="Test DSP Account",
            amazon_account_id="DSP456",
            account_type="dsp",
            marketplace_id="ATVPDKIKX0DER"
        )
        test_db.add(account_dsp)

        # Test AMC type
        account_amc = AmazonAccount(
            user_id="test-user-1",
            account_name="Test AMC Instance",
            amazon_account_id="AMC789",
            account_type="amc",
            marketplace_id="ATVPDKIKX0DER"
        )
        test_db.add(account_amc)

        test_db.commit()

        # Verify all accounts were created
        accounts = test_db.query(AmazonAccount).all()
        assert len(accounts) == 3
        assert accounts[0].account_type == "advertising"
        assert accounts[1].account_type == "dsp"
        assert accounts[2].account_type == "amc"

    def test_entity_id_column_stores_identifiers(self, test_db):
        """Test that entity_id column stores Amazon entity identifiers."""
        account = AmazonAccount(
            user_id="test-user-2",
            account_name="Test Account",
            amazon_account_id="ACC123",
            entity_id="ENTITY_ABC_123",
            account_type="advertising",
            marketplace_id="ATVPDKIKX0DER"
        )
        test_db.add(account)
        test_db.commit()

        retrieved = test_db.query(AmazonAccount).filter_by(user_id="test-user-2").first()
        assert retrieved.entity_id == "ENTITY_ABC_123"

    def test_profile_id_column_stores_numeric_identifiers(self, test_db):
        """Test that profile_id column stores numeric profile identifiers."""
        account = AmazonAccount(
            user_id="test-user-3",
            account_name="Test Account",
            amazon_account_id="ACC456",
            profile_id="123456789",
            account_type="advertising",
            marketplace_id="ATVPDKIKX0DER"
        )
        test_db.add(account)
        test_db.commit()

        retrieved = test_db.query(AmazonAccount).filter_by(user_id="test-user-3").first()
        assert retrieved.profile_id == "123456789"

    def test_last_managed_at_timestamp(self, test_db):
        """Test that last_managed_at column stores management timestamps."""
        now = datetime.now(timezone.utc)
        account = AmazonAccount(
            user_id="test-user-4",
            account_name="Test Account",
            amazon_account_id="ACC789",
            account_type="advertising",
            marketplace_id="ATVPDKIKX0DER",
            last_managed_at=now
        )
        test_db.add(account)
        test_db.commit()

        retrieved = test_db.query(AmazonAccount).filter_by(user_id="test-user-4").first()
        assert retrieved.last_managed_at is not None
        assert abs((retrieved.last_managed_at - now).total_seconds()) < 1

    def test_unique_constraint_on_identifiers(self, test_db):
        """Test unique constraints work correctly."""
        # Create first account
        account1 = AmazonAccount(
            user_id="test-user-5",
            account_name="Account 1",
            amazon_account_id="ACC001",
            entity_id="ENTITY_001",
            profile_id="111111111",
            account_type="advertising",
            marketplace_id="ATVPDKIKX0DER"
        )
        test_db.add(account1)
        test_db.commit()

        # Try to create duplicate with same amazon_account_id
        account2 = AmazonAccount(
            user_id="test-user-5",
            account_name="Account 2",
            amazon_account_id="ACC001",  # Duplicate
            entity_id="ENTITY_002",
            profile_id="222222222",
            account_type="advertising",
            marketplace_id="ATVPDKIKX0DER"
        )
        test_db.add(account2)

        with pytest.raises(IntegrityError):
            test_db.commit()

    def test_multiple_account_types_per_user(self, test_db):
        """Test that a user can have multiple accounts of different types."""
        user_id = "test-user-6"

        # Create accounts of each type
        accounts = [
            AmazonAccount(
                user_id=user_id,
                account_name="Sponsored Ads Account",
                amazon_account_id="SP001",
                account_type="advertising",
                marketplace_id="ATVPDKIKX0DER"
            ),
            AmazonAccount(
                user_id=user_id,
                account_name="DSP Account",
                amazon_account_id="DSP001",
                account_type="dsp",
                marketplace_id="ATVPDKIKX0DER"
            ),
            AmazonAccount(
                user_id=user_id,
                account_name="AMC Instance",
                amazon_account_id="AMC001",
                account_type="amc",
                marketplace_id="ATVPDKIKX0DER"
            )
        ]

        for account in accounts:
            test_db.add(account)
        test_db.commit()

        # Query accounts by type
        sponsored_accounts = test_db.query(AmazonAccount).filter_by(
            user_id=user_id, account_type="advertising"
        ).all()
        dsp_accounts = test_db.query(AmazonAccount).filter_by(
            user_id=user_id, account_type="dsp"
        ).all()
        amc_accounts = test_db.query(AmazonAccount).filter_by(
            user_id=user_id, account_type="amc"
        ).all()

        assert len(sponsored_accounts) == 1
        assert len(dsp_accounts) == 1
        assert len(amc_accounts) == 1

    def test_marketplaces_array_field(self, test_db):
        """Test that marketplaces can be stored as JSON array in metadata."""
        account = AmazonAccount(
            user_id="test-user-7",
            account_name="Multi-marketplace Account",
            amazon_account_id="MKT001",
            account_type="advertising",
            marketplace_id="ATVPDKIKX0DER",
            metadata={
                "marketplaces": ["US", "CA", "MX"],
                "alternateIds": [
                    {"countryCode": "US", "profileId": 123456789},
                    {"countryCode": "CA", "profileId": 987654321}
                ]
            }
        )
        test_db.add(account)
        test_db.commit()

        retrieved = test_db.query(AmazonAccount).filter_by(user_id="test-user-7").first()
        assert retrieved.metadata["marketplaces"] == ["US", "CA", "MX"]
        assert len(retrieved.metadata["alternateIds"]) == 2

    def test_account_relationships_table(self, test_db):
        """Test the account_relationships table for AMC associations."""
        # This would test the new relationships table
        # For now, we'll test the concept through metadata
        amc_account = AmazonAccount(
            user_id="test-user-8",
            account_name="AMC Instance with Associations",
            amazon_account_id="AMC002",
            account_type="amc",
            marketplace_id="ATVPDKIKX0DER",
            metadata={
                "associated_accounts": {
                    "sponsored_ads": [
                        {"profile_id": "123456789", "entity_id": "ENTITY123"}
                    ],
                    "dsp": [
                        {"profile_id": "987654321", "entity_id": "DSP456"}
                    ]
                }
            }
        )
        test_db.add(amc_account)
        test_db.commit()

        retrieved = test_db.query(AmazonAccount).filter_by(
            amazon_account_id="AMC002"
        ).first()
        assert "associated_accounts" in retrieved.metadata
        assert len(retrieved.metadata["associated_accounts"]["sponsored_ads"]) == 1
        assert len(retrieved.metadata["associated_accounts"]["dsp"]) == 1


class TestAccountTypeDetection:
    """Test account type detection from Amazon API responses."""

    def test_detect_sponsored_ads_account(self):
        """Test detection of Sponsored Ads account from API response."""
        api_response = {
            "adsAccountId": "ENTITY123",
            "accountName": "Test Advertiser",
            "alternateIds": [
                {"countryCode": "US", "profileId": 123456789}
            ],
            "countryCodes": ["US"],
            "status": "CREATED"
        }

        # Would be implemented in the service layer
        account_type = self._detect_account_type(api_response)
        assert account_type == "advertising"

    def test_detect_dsp_account(self):
        """Test detection of DSP account from API response."""
        api_response = {
            "advertiserId": "DSP123",
            "advertiserName": "Test DSP Advertiser",
            "advertiserType": "BRAND",
            "entityId": "DSP_ENTITY_456"
        }

        account_type = self._detect_account_type(api_response)
        assert account_type == "dsp"

    def test_detect_amc_instance(self):
        """Test detection of AMC instance from API response."""
        api_response = {
            "instanceId": "AMC789",
            "instanceName": "Test AMC Instance",
            "dataSetId": "dataset_xyz",
            "advertisers": [
                {"advertiserId": "ADV123", "type": "SPONSORED_ADS"},
                {"advertiserId": "DSP456", "type": "DSP"}
            ]
        }

        account_type = self._detect_account_type(api_response)
        assert account_type == "amc"

    def _detect_account_type(self, api_response):
        """Helper method to detect account type from API response."""
        if "adsAccountId" in api_response:
            return "advertising"
        elif "advertiserId" in api_response and "advertiserType" in api_response:
            return "dsp"
        elif "instanceId" in api_response and "dataSetId" in api_response:
            return "amc"
        return None


if __name__ == "__main__":
    pytest.main([__file__, "-v"])